<!DOCTYPE html>




<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  
    
    Proof of Spacetime
  
 | Filecoin Spec</title>



<link rel="stylesheet" href="../../../book.min.dd7edd971a70e42d8b77dee6408ce13a65b881f03c3da4d4895f894b428e6946.css">


<link rel="icon" href="../../../favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <link rel="stylesheet" href="../../../css/syntax.css">
<link href="../../../mermaid/mermaid.css" type="text/css" rel="stylesheet" />
<script src="../../../mermaid/mermaid.js"></script>

</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">
<h2 class="book-brand">
  <a href="">Filecoin Spec</a>
</h2>



    
  
  
  

  <style>
  nav ul a[href$="\2f docs\2f algorithms\2fproof_of_spacetime\2f "] {
      color: #0b3a53;
  }
  </style>


  <div>
  <ul>
    
      
      <li>
        











<a href="../../../#intro">    
    
    <strong>
    
        Introduction
    
    </strong>
    
</a>


<ul>

    <li>
    
      











<a href="../../../#intro__arch">    
    
        Architecture Diagram
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#intro__concepts">    
    
        Key Concepts
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#intro__filecoin_vm">    
    
        Filecoin VM
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#intro__process">    
    
        Spec Process
    
</a>



    
    </li>

</ul>


      </li>
    
      
      <li>
        











<a href="../../../#algorithms">    
    
    <strong>
    
        Algorithms
    
    </strong>
    
</a>


<ul>

    <li>
    
      











<a href="../../../#algorithms__expected_consensus">    
    
        Expected Consensus
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#algorithms__proof_of_replication">    
    
        Proof of Replication
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#algorithms__proof_of_spacetime">    
    
        Proof of Spacetime
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#algorithms__payment_channels">    
    
        Payment Channels
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#algorithms__vdf">    
    
        Verifiable Delay Functions
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#algorithms__crypto">    
    
        Cryptographic Primitives
    
</a>



    
    </li>

</ul>


      </li>
    
      
      <li>
        











<a href="../../../#subsystems">    
    
    <strong>
    
        Subsystems
    
    </strong>
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__blockchain">    
    
        Blockchain
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__blockchain__components">    
    
        Blockchain Components
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__blockchain__components__block_receiver">    
    
        Block Receiver
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__blockchain__components__block_propagator">    
    
        Block Propagator
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__blockchain__components__chain_manager">    
    
        Chain Manager
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__blockchain__components__block_producer">    
    
        Block Producer
    
</a>


<ul>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__blockchain__libp2p">    
    
        libp2p Protocols
    
</a>


<ul>

    <li>
    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__vm">    
    
        Filecoin VM
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__vm__components">    
    
        Filecoin VM Components
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../#subsystems__vm__components__vm_interpreter">    
    
        VM Interpreter
    
</a>


<ul>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__vm__actors">    
    
        Filecoin VM Actors
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__vm__actors__standard">    
    
        Standard Actors
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__vm__actors__singleton">    
    
        Singleton Actors
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__storage">    
    
        Storage Market
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../#listings__actors">    
    
        Filecoin VM Actors
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__storage__components">    
    
        Storage Market Components
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__storage__components__storage_provider">    
    
        Storage Provider
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__storage__libp2p">    
    
        libp2p Protocols
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__retrieval">    
    
        Retrieval Market
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../#listings__actors">    
    
        Filecoin VM Actors
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__retrieval__components">    
    
        Retrieval Market Components
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__mining">    
    
        Storage Mining
    
</a>


<ul>

    <li>
    
      











<a href="../../../#subsystems__mining__actors">    
    
        Storage Mining Actors
    
</a>


<ul>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__mining__components">    
    
        Storage Mining Components
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../#subsystems__mining__components__proof_generator">    
    
        Proof Generator
    
</a>


<ul>

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#subsystems__network">    
    
        Network Interface
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../#subsystems__repository">    
    
        Repository
    
</a>


<ul>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

</ul>


      </li>
    
      
      <li>
        











<a href="../../../#listings">    
    
    <strong>
    
        Listings
    
    </strong>
    
</a>


<ul>

    <li>
    
      











<a href="../../../#listings__actors">    
    
        Filecoin VM Actors
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#listings__data_structures">    
    
        Data Structures
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#listings__components">    
    
        Components
    
</a>


<ul>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../#listings__libp2p_protocols">    
    
        libp2p Protocols
    
</a>


<ul>

</ul>


    
    </li>

</ul>


      </li>
    
      
      <li>
        











<a href="../../../#glossary">    
    
    <strong>
    
        Glossary
    
    </strong>
    
</a>


<ul>

</ul>


      </li>
    
      
      <li>
        











<a href="../../../#appendix">    
    
    <strong>
    
        Appendix
    
    </strong>
    
</a>



      </li>
    
  </ul>
</div>








</nav>


  
<script>
(function() {
  var menu = document.querySelector('aside.book-menu nav')
  addEventListener('beforeunload', function(event) {
    localStorage.setItem('menu.scrollTop', menu.scrollTop)
  });
  menu.scrollTop = localStorage.getItem('menu.scrollTop')
})()
</script>



    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="../../../svg/menu.svg" alt="Menu" />
  </label>
  <strong>
  
    
    Proof of Spacetime
  
</strong>
</header>

      
<article class="markdown">
  

<p>This document describes Rational-PoSt, the Proof-of-Spacetime used in Filecoin.</p>

<h2 id="rational-post">Rational PoSt</h2>

<h3 id="definitions">Definitions</h3>

<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>POST_PROVING_PERIOD</code></td>
<td><code>2880</code> blocks  (~24h)</td>
<td>The time interval in which a PoSt has to be submitted.</td>
</tr>

<tr>
<td><code>POST_CHALLENGE_TIME</code></td>
<td><code>240</code> blocks (~2h)</td>
<td>The time offset at which the actual work of generating the PoSt <strong>can not</strong> be started earlier than. This is some delta before the end of the <code>Proving Period</code>, and as such less then a single <code>Proving Period</code>.</td>
</tr>
</tbody>
</table>

<div class="notices todo" ><strong>TODO</strong>: The above values are tentative and need both backing from research as well as detailed reasoning why we picked them.</div>

<h3 id="high-level-api">High Level API</h3>

<h4 id="fault-detection">Fault Detection</h4>

<p>Fault detection happens over the course of the life time of a sector. When the sector is for some reason unavailable, the miner is responsible to submit the known <code>faults</code>, before the PoSt challenge begins. (Using the <code>AddFaults</code> message to the chain).
Only faults which have been reported at challenge time, will be accounted for. If any other faults have occured the miner can not submit a valid PoSt for this proving period.</p>

<p>The PoSt generation then takes the latest available <code>faults</code> of the miner to generate a PoSt matching the committed sectors and faults.</p>

<p>When a PoSt is successfully submitted all faults are reset and assumed to be recovered. A miner must either (1) resolve a faulty sector and accept challenges against it in the next proof submission, (2) report a sector faulty again if it persists but is eventually recoverable, (3) report a sector faulty <em>and done</em> if the fault cannot be recovered.</p>

<p>If the miner knows that the sectors are permanently lost, they can submit them as part of the <code>doneSet</code>, to ensure they are removed from the proving set.</p>

<div class="notices note" ><strong>Note</strong>: It is important that all faults are known (i.e submitted to the chain) prior to challenge generation, because otherwise it would be possible to know the challenge set, before the actual challenge time. This would allow a miner to report only faults on challenged sectors, with a gurantee that other faulty sectors would not be detected.</div>

<div class="notices todo" ><strong>TODO</strong>: The penalization for faults is not clear yet.</div>

<h4 id="fault-penalization">Fault Penalization</h4>

<p>Each reported fault carries a penality with it.</p>

<div class="notices todo" ><strong>TODO</strong>: Define the exact penality structure for this.</div>

<h4 id="generation">Generation</h4>

<p><code>GeneratePoSt</code> generates a <strong><em>Proof of Spacetime</em></strong> over all  <strong><em>sealed sectors</em></strong> of a single miner— identified by their <code>commR</code> commitments. This is accomplished by performing a series of merkle inclusion proofs (<strong><em>Proofs of Retrievability</em></strong>). Each proof is of a challenged node in a challenged sector. The challenges are generated pseudo-randomly, based on the provided <code>seed</code>. At each time step, a number of <strong><em>Proofs of Retrievability</em></strong> are performed.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Generate a new PoSt.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GeneratePoSt</span><span class="p">(</span><span class="nx">sectorSize</span> <span class="nx">BytesAmount</span><span class="p">,</span> <span class="nx">sectors</span> <span class="nx">SectorSet</span><span class="p">,</span> <span class="nx">seed</span> <span class="nx">Seed</span><span class="p">,</span> <span class="nx">faults</span> <span class="nx">FaultSet</span><span class="p">)</span> <span class="nx">PoStProof</span> <span class="p">{</span>
    <span class="c1">// Generate the Merkle Inclusion Proofs + Faults
</span><span class="c1"></span>
    <span class="nx">challenges</span> <span class="o">:=</span> <span class="nf">DerivePoStChallenges</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">faults</span><span class="p">,</span> <span class="nx">sectorSize</span><span class="p">,</span> <span class="nf">SortAsc</span><span class="p">(</span><span class="nf">GetSectorIds</span><span class="p">(</span><span class="nx">sectors</span><span class="p">)))</span>
    <span class="nx">challengedSectors</span> <span class="o">:=</span> <span class="p">[]</span>
    <span class="nx">inclusionProofs</span> <span class="o">:=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">challenges</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">challenge</span> <span class="o">:=</span> <span class="nx">challenges</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

        <span class="c1">// Leaf index of the selected sector
</span><span class="c1"></span>        <span class="nx">inclusionProof</span><span class="p">,</span> <span class="nx">isFault</span> <span class="o">:=</span> <span class="nf">GenerateMerkleInclusionProof</span><span class="p">(</span><span class="nx">challenge</span><span class="p">.</span><span class="nx">Sector</span><span class="p">,</span> <span class="nx">challenge</span><span class="p">.</span><span class="nx">Leaf</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">isFault</span> <span class="p">{</span>
            <span class="c1">// faulty sector, need to post a fault to the chain and try to recover from it
</span><span class="c1"></span>            <span class="k">return</span> <span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;Detected late fault&#34;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">inclusionProofs</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="p">=</span> <span class="nx">inclusionProof</span>
        <span class="nx">challengedSectors</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">sectors</span><span class="p">[</span><span class="nx">challenge</span><span class="p">.</span><span class="nx">Sector</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">// Generate the snark
</span><span class="c1"></span>    <span class="nx">snarkProof</span> <span class="o">:=</span> <span class="nf">GeneratePoStSnark</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">,</span> <span class="nx">challenges</span><span class="p">,</span> <span class="nx">challengedSectors</span><span class="p">,</span> <span class="nx">inclusionProofs</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">snarkProof</span>
<span class="p">}</span></code></pre></div>
<h4 id="verification">Verification</h4>

<p><code>VerifyPoSt</code> is the functional counterpart to <code>GeneratePoSt</code>. It takes all of <code>GeneratePoSt</code>&rsquo;s output, along with those of <code>GeneratePost</code>&rsquo;s inputs required to identify the claimed proof. All inputs are required because verification requires sufficient context to determine not only that a proof is valid but also that the proof indeed corresponds to what it purports to prove.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Verify a PoSt.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">VerifyPoSt</span><span class="p">(</span><span class="nx">sectorSize</span> <span class="nx">BytesAmount</span><span class="p">,</span> <span class="nx">sectors</span> <span class="nx">SectorSet</span><span class="p">,</span> <span class="nx">seed</span> <span class="nx">Seed</span><span class="p">,</span> <span class="nx">proof</span> <span class="nx">PoStProof</span><span class="p">,</span> <span class="nx">faults</span> <span class="nx">FaultSet</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">challenges</span> <span class="o">:=</span> <span class="nf">DerivePoStChallenges</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">faults</span><span class="p">,</span> <span class="nx">sectorSize</span><span class="p">,</span> <span class="nf">SortAsc</span><span class="p">(</span><span class="nf">GetSectorIds</span><span class="p">(</span><span class="nx">sectors</span><span class="p">)))</span>
    <span class="nx">challengedSectors</span> <span class="o">:=</span> <span class="p">[]</span>

    <span class="c1">// Match up commitments with challenges
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">challenges</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">challengedSectors</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">sectors</span><span class="p">[</span><span class="nx">challenges</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Sector</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">// Verify snark
</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">VerifyPoStSnark</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">,</span> <span class="nx">challenges</span><span class="p">,</span> <span class="nx">challengedSectors</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h4 id="types">Types</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// The random challenge seed, provided by the chain.
</span><span class="c1"></span><span class="nx">Seed</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="kt">byte</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Challenge</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Sector</span> <span class="nx">SectorID</span>
    <span class="nx">Leaf</span> <span class="nx">Uint</span>
<span class="p">}</span></code></pre></div>
<h4 id="challenge-derivation">Challenge Derivation</h4>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Derive the full set of challenges for PoSt.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DerivePoStChallenges</span><span class="p">(</span><span class="nx">seed</span> <span class="nx">Seed</span><span class="p">,</span> <span class="nx">faults</span> <span class="nx">FaultSet</span><span class="p">,</span> <span class="nx">sectorSize</span> <span class="nx">Uint</span><span class="p">,</span> <span class="nx">sortedSectors</span> <span class="p">[]</span><span class="nx">SectorID</span><span class="p">)</span> <span class="p">[</span><span class="nx">POST_CHALLENGES_COUNT</span><span class="p">]</span><span class="nx">Challenge</span> <span class="p">{</span>
    <span class="nx">challenges</span> <span class="o">:=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nx">POST_CHALLENGES_COUNT</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">attemptedSectors</span> <span class="o">:=</span> <span class="p">{</span><span class="nx">SectorID</span><span class="p">:</span><span class="kt">bool</span><span class="p">}</span>
        <span class="nx">while</span> <span class="nx">challenges</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">challenge</span> <span class="o">:=</span> <span class="nf">DerivePoStChallenge</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">attempt</span><span class="p">,</span> <span class="nx">sectorSize</span><span class="p">,</span> <span class="nx">sortedSectors</span><span class="p">)</span>

            <span class="c1">// check if we landed in a faulty sector
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">faults</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">challenge</span><span class="p">.</span><span class="nx">Sector</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Valid challenge
</span><span class="c1"></span>                <span class="nx">challenges</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="p">=</span> <span class="nx">challenge</span>
            <span class="p">}</span>

            <span class="c1">// invalid challenge, regenerate
</span><span class="c1"></span>            <span class="nx">attemptedSectors</span><span class="p">[</span><span class="nx">challenge</span><span class="p">.</span><span class="nx">Sector</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">attemptedSectors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">sortedSectors</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;All sectors are faulty&#34;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">challenges</span>
<span class="p">}</span>

<span class="c1">// Derive a single challenge for PoSt.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DerivePoStChallenge</span><span class="p">(</span><span class="nx">seed</span> <span class="nx">Seed</span><span class="p">,</span> <span class="nx">n</span> <span class="nx">Uint</span><span class="p">,</span> <span class="nx">attempt</span> <span class="nx">Uint</span><span class="p">,</span> <span class="nx">sectorSize</span> <span class="nx">Uint</span><span class="p">,</span> <span class="nx">sortedSectors</span> <span class="p">[]</span><span class="nx">SectorID</span><span class="p">)</span> <span class="nx">Challenge</span> <span class="p">{</span>
    <span class="nx">nBytes</span> <span class="o">:=</span> <span class="nf">WriteUintToLittleEndian</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">:=</span> <span class="nf">concat</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="nx">nBytes</span><span class="p">,</span> <span class="nf">WriteUintToLittleEndian</span><span class="p">(</span><span class="nx">attempt</span><span class="p">))</span>
    <span class="nx">challengeBytes</span> <span class="o">:=</span> <span class="nf">blake2b</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

    <span class="nx">sectorChallenge</span> <span class="o">:=</span> <span class="nf">ReadUintLittleEndian</span><span class="p">(</span><span class="nx">challengeBytes</span><span class="p">[</span><span class="mf">0..8</span><span class="p">])</span>
    <span class="nx">leafChallenge</span> <span class="o">:=</span> <span class="nf">ReadUintLittleEndian</span><span class="p">(</span><span class="nx">challengeBytes</span><span class="p">[</span><span class="mf">8..16</span><span class="p">])</span>

    <span class="nx">sectorIdx</span> <span class="o">:=</span> <span class="nx">sectorChallenge</span> <span class="o">%</span> <span class="nx">sectorCount</span>

    <span class="k">return</span> <span class="nx">Challenge</span> <span class="p">{</span>
        <span class="nx">Sector</span><span class="p">:</span> <span class="nx">sortedSectors</span><span class="p">[</span><span class="nx">sectorIdx</span><span class="p">],</span>
        <span class="nx">Leaf</span><span class="p">:</span> <span class="nx">leafChallenge</span> <span class="o">%</span> <span class="p">(</span><span class="nx">sectorSize</span> <span class="o">/</span> <span class="nx">NODE_SIZE</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="post-circuit">PoSt Circuit</h3>

<h4 id="public-parameters">Public Parameters</h4>

<p><em>Parameters that are embeded in the circuits or used to generate the circuit</em></p>

<ul>
<li><code>POST_CHALLENGES_COUNT: UInt</code>: Number of challenges.</li>
<li><code>POST_TREE_DEPTH: UInt</code>: Depth of the Merkle tree. Note, this is <code>(log_2(Size of original data in bytes/32 bytes per leaf))</code>.</li>
<li><code>SECTOR_SIZE: UInt</code>: The size of a single sector in bytes.</li>
</ul>

<h4 id="public-inputs">Public Inputs</h4>

<p><em>Inputs that the prover uses to generate a SNARK proof and that the verifier uses to verify it</em></p>

<ul>
<li><code>CommRs: [POST_CHALLENGES_COUNT]Fr</code>: The Merkle tree root hashes of all replicas, ordered to match the inclusion paths and challenge order.</li>
<li><code>InclusionPaths: [POST_CHALLENGES_COUNT]Fr</code>: Inclusion paths for the replica leafs, ordered to match the <code>CommRs</code> and challenge order. (Binary packed bools)</li>
</ul>

<h4 id="private-inputs">Private Inputs</h4>

<p><em>Inputs that the prover uses to generate a SNARK proof, these are not needed by the verifier to verify the proof</em></p>

<ul>
<li><code>InclusionProofs: [POST_CHALLENGES_COUNT][TREE_DEPTH]Fr</code>: Merkle tree inclusion proofs, ordered to match the challenge order.</li>
<li><code>InclusionValues: [POST_CHALLENGES_COUNT]Fr</code>: Value of the encoded leaves for each challenge, ordered to match challenge order.</li>
</ul>

<h4 id="circuit">Circuit</h4>

<h5 id="high-level">High Level</h5>

<p>In high level, we do 1 check:</p>

<ol>
<li><strong>Inclusion Proofs Checks</strong>: Check the inclusion proofs</li>
</ol>

<h5 id="details">Details</h5>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="k">for</span> <span class="nx">c</span> <span class="nx">in</span> <span class="k">range</span> <span class="nx">POST_CHALLENGES_COUNT</span> <span class="p">{</span>
  <span class="c1">// Inclusion Proofs Checks
</span><span class="c1"></span>  <span class="nf">assert</span><span class="p">(</span><span class="nf">MerkleTreeVerify</span><span class="p">(</span><span class="nx">CommRs</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span> <span class="nx">InclusionPath</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span> <span class="nx">InclusionProof</span><span class="p">[</span><span class="nx">c</span><span class="p">],</span> <span class="nx">InclusionValue</span><span class="p">[</span><span class="nx">c</span><span class="p">]))</span>
<span class="p">}</span></code></pre></div>
<h4 id="verification-of-post-proof">Verification of PoSt proof</h4>

<ul>
<li>SNARK proof check: <strong>Check</strong> that given the SNARK proof and the public inputs, the SNARK verification outputs true</li>
</ul>

</article>

      

      
    </div>

    
  
  
  <aside class="book-toc fixed">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#rational-post">Rational PoSt</a>
<ul>
<li><a href="#definitions">Definitions</a></li>
<li><a href="#high-level-api">High Level API</a>
<ul>
<li><a href="#fault-detection">Fault Detection</a></li>
<li><a href="#fault-penalization">Fault Penalization</a></li>
<li><a href="#generation">Generation</a></li>
<li><a href="#verification">Verification</a></li>
<li><a href="#types">Types</a></li>
<li><a href="#challenge-derivation">Challenge Derivation</a></li>
</ul></li>
<li><a href="#post-circuit">PoSt Circuit</a>
<ul>
<li><a href="#public-parameters">Public Parameters</a></li>
<li><a href="#public-inputs">Public Inputs</a></li>
<li><a href="#private-inputs">Private Inputs</a></li>
<li><a href="#circuit">Circuit</a>
<ul>
<li><a href="#high-level">High Level</a></li>
<li><a href="#details">Details</a></li>
</ul></li>
<li><a href="#verification-of-post-proof">Verification of PoSt proof</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>
  
  
  
</body>

</html>
